<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FisioHeav - Reporte Profesional</title>

<link rel="manifest" href="manifest.json">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<style>
/* COLORES DEL LOGO */
:root {

  --morado: #8e44ad;

  --rosa: #e91e63;

  --morado-claro: #9b59b6;

  --fondo: #fdfaff;

  --borde: #e1c4ff;

}

body {font-family:Arial,sans-serif;background:var(--fondo);margin:0;padding:10px;color:#2c3e50}
.cont {max-width:1100px;margin:auto;background:white;border-radius:24px;overflow:hidden;box-shadow:0 20px 60px rgba(142,68,173,0.18)}
header {background:linear-gradient(135deg,var(--morado),var(--morado-claro));color:white;padding:40px;text-align:center}
header img {height:160px;margin-bottom:15px}
h1 {font-size:52px;margin:0;font-weight:300;letter-spacing:5px}
h2 {background:var(--morado);color:white;padding:20px;margin:0;border-radius:16px 16px 0 0;font-size:22px;font-weight:600}
section {padding:30px;border-bottom:2px solid #f0e0ff}
/* Estilo de label global (se ajusta a continuación para el grid) */
label {font-weight:bold;color:var(--morado);margin:15px 0 8px;font-size:15px} 

input,select,textarea {width:100%;padding:14px;border:2px solid var(--borde);border-radius:14px;font-size:16px;box-sizing:border-box;transition:0.3s}
input:focus,select:focus,textarea:focus {border-color:var(--morado);box-shadow:0 0 0 4px rgba(142,68,173,0.2)}
.grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:22px}

/* ESTILOS PARA LA SECCIÓN PROFESIONAL */
.grid > div {
    display: flex;
    flex-direction: column;
}
.grid > div label {
    margin-top: 0;
    margin-bottom: 5px;
    color: #555;
    font-weight: normal;
}
input[readonly] {
    border: 1px solid var(--borde);
    background: #f7f7f7; /* Fondo más claro para inputs de solo lectura */
    font-weight: bold;
    color: #444;
}
/* FIN ESTILOS */

.checkgrid {display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px}
.sliderbox {position:relative;margin:15px 0}
.sliderval {position:absolute;right:15px;top:14px;background:var(--morado);color:white;padding:6px 16px;border-radius:12px;font-weight:bold;font-size:14px}
.upload {border:4px dashed var(--morado);padding:50px;text-align:center;border-radius:20px;cursor:pointer;background:#f8f0ff;color:var(--morado);font-size:18px;transition:0.3s; position:relative;} 
.upload:hover {background:#f0e0ff;border-color:var(--rosa)}
.prev {display:flex;flex-wrap:wrap;gap:18px;margin-top:20px}
.image-container {position: relative; max-height: 200px;}
.prev img {max-height:200px;border-radius:16px;border:4px solid var(--morado);box-shadow:0 10px 25px rgba(142,68,173,0.2)}
.delete-img-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    background: #e74c3c;
    color: white;
    border: 3px solid white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    font-size: 18px;
    z-index: 10;
}
.consentimiento-check {
    display: flex;
    align-items: center;
    margin-top: 15px;
    padding: 10px;
    border: 2px solid var(--morado);
    border-radius: 10px;
    background: #f8f0ff;
    width: fit-content;
}
.consentimiento-check label {
    margin: 0;
    margin-left: 10px;
    font-size: 18px;
    color: #2c3e50;
    font-weight: normal;
}
.consentimiento-check input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin: 0;
    cursor: pointer;
}

canvas {border:3px solid var(--morado);border-radius:16px;width:100%;height:200px;background:white}
.btn {background:linear-gradient(135deg,var(--morado),var(--rosa));color:white;padding:24px;font-size:28px;border:none;border-radius:20px;cursor:pointer;margin:50px 30px;width:calc(100% - 60px);font-weight:bold;box-shadow:0 12px 35px rgba(142,68,173,0.4);transition:0.3s}
.btn:hover {transform:translateY(-4px);box-shadow:0 18px 50px rgba(142,68,173,0.5)}
.limpiar {background:#e74c3c;color:white;padding:10px 20px;border:none;border-radius:10px;margin-top:10px;cursor:pointer;margin-left: 10px; font-size: 14px;}
</style>
</head>
<body>

<div class="cont">
<header>
  <img src="https://scontent.ftgz1-1.fna.fbcdn.net/v/t39.30808-6/566228684_25020217447666386_1034558766853531360_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=B0GSWpfcMUMQ7kNvwGfHxtF&_nc_oc=Adl0oUrx4ZGWTb3CM9CV-6qITPCP-JxKcN43j_RMBYbHOmlBmShVfA62mszx50faTuE&_nc_zt=23&_nc_ht=scontent.ftgz1-1.fna&_nc_gid=gO3oNE9G78R6UWFn53Ly_A&oh=00_AfmGG1gj061o333dTAL1eoUo8RwdfgaOLICWcYXJiSFhyw&oe=693D630D" alt="FisioHeav">
  <h1>FisioHeav</h1>
</header>

<form id="form">
<section>
    <h2>Información del Profesional</h2>
    <div class="grid">
        <div>
            <label>Profesional</label>
            <input value="LFT. Isabel Catalina Herrera Ávila" readonly>
        </div>
        <div>
            <label>Cédula</label>
            <input value="15129903" readonly>
        </div>
        <div>
            <label>Clínica</label>
            <input value="FisioHeav" readonly>
        </div>
        <div>
            <label for="fecha-reporte">Fecha del Reporte</label>
            <input type="date" id="fecha-reporte" value="2025-12-05">
        </div>
    </div>
</section>

<section><h2>1. Datos del Paciente</h2>
<div class="grid">
<input id="nombre-paciente" placeholder="Nombre Completo *" required>
<input id="edad-paciente" type="number" placeholder="Edad">
<select id="genero-paciente"><option>Masculino</option><option>Femenino</option><option>Otro</option></select>
<input id="tel-paciente" type="tel" placeholder="Teléfono">
<input id="ocupacion-paciente" placeholder="Ocupación">
<select id="dominancia-paciente"><option>Diestro</option><option>Zurdo</option></select>
</div>
</section>

<section><h2>2. Anamnesis y Antecedentes</h2>
<textarea id="mc" rows="3" placeholder="Motivo de Consulta (MC)"></textarea>
<textarea id="pa" rows="4" placeholder="Padecimiento Actual (PA)"></textarea>
<label>Antecedentes Médicos</label>
<div id="antecedentes" class="checkgrid">
<label><input type="checkbox" value="Diabetes">Diabetes</label>
<label><input type="checkbox" value="Hipertensión">Hipertensión</label>
<label><input type="checkbox" value="Reumática">Reumática</label>
<label><input type="checkbox" value="Alergias">Alergias</label>
<label><input type="checkbox" value="Cirugías">Cirugías</label>
<label><input type="checkbox" value="Fracturas">Fracturas</label>
<label><input type="checkbox" value="Ninguno">Ninguno</label>
</div>
</section>

<section><h2>3. Evaluación Subjetiva del Dolor (EVA)</h2>
<div class="grid">
<input id="localizacion-dolor" placeholder="Localización del Dolor">
<input id="patron-irradiacion" placeholder="Patrón de Irradiación">
</div>
<div class="sliderbox"><label>Dolor Actual</label><input type="range" min="0" max="10" value="5" id="eva"><span class="sliderval" id="evaV">5</span></div>
</section>

<section><h2>4. Exploración Física y Funcional</h2>
<h3>1. Signos Vitales</h3>
<div class="grid">
<div class="sliderbox"><label>FC</label><input type="range" min="40" max="200" value="115" id="fc"><span class="sliderval" id="fcV">115</span></div>
<div class="sliderbox"><label>FR</label><input type="range" min="10" max="40" value="24" id="fr"><span class="sliderval" id="frV">24</span></div>
<input id="pa-input" placeholder="PA" value="120/80">
<div class="sliderbox"><label>Temp</label><input type="range" min="35" max="42" step="0.1" value="37.1" id="temp"><span class="sliderval" id="tempV">37.1</span></div>
<div class="sliderbox"><label>SpO2</label><input type="range" min="80" max="100" value="99" id="spo2"><span class="sliderval" id="spo2V">99</span></div>
</div>

<h3>2. Balance y Coordinación</h3>
<div class="grid">
<div class="sliderbox"><label>Estático</label><input type="range" min="0" max="10" value="10" id="es"><span class="sliderval" id="esV">10</span></div>
<div class="sliderbox"><label>Dinámico</label><input type="range" min="0" max="10" value="10" id="di"><span class="sliderval" id="diV">10</span></div>
<div class="sliderbox"><label>Coordinación</label><input type="range" min="0" max="10" value="10" id="co"><span class="sliderval" id="coV">10</span></div>
<div class="sliderbox"><label>Propiocepción</label><input type="range" min="0" max="10" value="10" id="pr"><span class="sliderval" id="prV">10</span></div>
</div>

<h3>3. Evaluación Respiratoria y Circulatoria Básica</h3>
<textarea id="auscultacion" rows="3" placeholder="Auscultación pulmonar"></textarea>
<div class="grid">
<select id="pulsos-perifericos"><option>Normales</option><option>Disminuidos</option><option>Ausentes</option></select>
<select id="llenado-capilar"><option>Normal (< 2s)</option><option>Retardado (≥ 2s)</option></select>
<select id="edema"><option>No</option><option>Leve (+1)</option><option>Moderado (+2)</option><option>Severo (+3/+4)</option></select>
</div>

<h3>4. Integridad Cutánea y Cicatrices</h3>
<textarea id="piel-descripcion" rows="3" placeholder="Descripción de la piel"></textarea>
<textarea id="cicatrices-descripcion" rows="3" placeholder="Cicatrices"></textarea>
<input id="temp-local" placeholder="Temperatura Local">

<h3>5. Evaluación Muscular y ROM</h3>
<input id="rom-activo" placeholder="ROM Activo (grados)">
<input id="rom-pasivo" placeholder="ROM Pasivo (grados)">
<input id="fuerza-muscular" placeholder="Fuerza Muscular (Daniels 0-5)">
<select id="tono-muscular"><option>Normal</option><option>Hipotónico</option><option>Hipertónico/Espástico</option></select>
<input id="perimetros" placeholder="Perímetros Musculares / Edema">

<h3>6. Sensibilidad y Reflejos Osteotendinosos</h3>
<div class="grid">
<select id="reflejo-biceps"><option>0</option><option>1</option><option selected>2</option><option>3</option><option>4</option></select> Bíceps
<select id="reflejo-triceps"><option>0</option><option>1</option><option selected>2</option><option>3</option><option>4</option></select> Tríceps
<select id="reflejo-rotuliano"><option>0</option><option>1</option><option selected>2</option><option>3</option><option>4</option></select> Rotuliano
<select id="reflejo-aquileo"><option>0</option><option>1</option><option selected>2</option><option>3</option><option>4</option></select> Aquileo
</div>
<div class="grid">
<div class="sliderbox"><label>Táctil</label><input type="range" min="0" max="10" value="10" id="tac"><span class="sliderval" id="tacV">10</span></div>
<div class="sliderbox"><label>Térmica</label><input type="range" min="0" max="10" value="10" id="ter"><span class="sliderval" id="terV">10</span></div>
<div class="sliderbox"><label>Dolorosa</label><input type="range" min="0" max="10" value="10" id="dol"><span class="sliderval" id="dolV">10</span></div>
</div>

<h3>7. Evaluación de la Postura y Marcha</h3>
<div class="grid">
<select id="marcha-tipo"><option>Normal</option><option>Antálgica</option><option>Trendelenburg</option><option>Atáxica</option></select>
<select id="asistencia-marcha"><option>Independiente</option><option>Supervisión</option><option>Ayuda mínima</option></select>
</div>
<div id="postura" class="checkgrid">
<label><input type="checkbox" value="Normal">Normal</label><label><input type="checkbox" value="Escoliosis">Escoliosis</label>
<label><input type="checkbox" value="Cifosis">Cifosis</label><label><input type="checkbox" value="Hiperlordosis">Hiperlordosis</label>
<label><input type="checkbox" value="Asimetría Pélvica">Asimetría Pélvica</label><label><input type="checkbox" value="Otra">Otra</label>
</div>

<h3>8. Valoración Funcional Global (0-10)</h3>
<div class="grid">
<div class="sliderbox"><label>AVDs</label><input type="range" min="0" max="10" value="5" id="avd"><span class="sliderval" id="avdV">5</span></div>
<div class="sliderbox"><label>Transferencias</label><input type="range" min="0" max="10" value="5" id="tra"><span class="sliderval" id="traV">5</span></div>
<div class="sliderbox"><label>Escaleras</label><input type="range" min="0" max="10" value="5" id="esc"><span class="sliderval" id="escV">5</span></div>
<div class="sliderbox"><label>Marcha</label><input type="range" min="0" max="10" value="5" id="mar"><span class="sliderval" id="marV">5</span></div>
<div class="sliderbox"><label>Alcance</label><input type="range" min="0" max="10" value="5" id="alc"><span class="sliderval" id="alcV">5</span></div>
<div class="sliderbox"><label>Tolerancia Esfuerzo</label><input type="range" min="0" max="10" value="5" id="tol"><span class="sliderval" id="tolV">5</span></div>
</div>

<h3>9. Hallazgos Adicionales</h3>
<input id="escalas-hallazgos" placeholder="Escala Tinneti/Berg">
<select id="pronostico-corto"><option>Nula</option><option>Leve</option><option>Moderada</option><option>Severa</option></select>
<textarea id="pruebas-especiales" rows="3" placeholder="Pruebas Especiales Positivas / Observaciones"></textarea>
</section>

<section><h2>Diagnóstico y Plan de Tratamiento</h2>
<textarea id="diagnostico-funcional" rows="4" placeholder="Diagnóstico Funcional"></textarea>
<div class="grid">
<select id="estado-lesion"><option>Aguda</option><option>Subaguda</option><option>Crónica</option></select>
<select id="pronostico-largo"><option>Excelente</option><option>Bueno</option><option>Reservado</option></select>
</div>
<textarea id="objetivos-terapeuticos" rows="5" placeholder="Objetivos Terapéuticos"></textarea>
<label>Modalidades</label>
<div id="modalidades" class="checkgrid">
<label><input type="checkbox" value="Terapia Manual">Terapia Manual</label><label><input type="checkbox" value="Ejercicio">Ejercicio</label>
<label><input type="checkbox" value="Electroterapia">Electroterapia</label><label><input type="checkbox" value="Termoterapia">Termoterapia</label>
<label><input type="checkbox" value="Ultras./Láser">Ultras./Láser</label><label><input type="checkbox" value="Punción">Punción</label>
</div>
<textarea id="indicaciones-casa" rows="4" placeholder="Indicaciones para Casa"></textarea>
<textarea id="criterios-alta" rows="3" placeholder="Criterios de Alta"></textarea>
<textarea id="seguimiento" rows="2" placeholder="Seguimiento"></textarea>
</section>

<section><h2>Documentación y Firmas</h2>
<h3>Fotografía Clínica</h3>
<div class="grid">
<div class="upload" onclick="document.getElementById('f1').click()">Imagen 1<input type="file" id="f1" data-index="0" style="display:none" accept="image/*"></div>
<div class="upload" onclick="document.getElementById('f2').click()">Imagen 2<input type="file" id="f2" data-index="1" style="display:none" accept="image/*"></div>
<div class="upload" onclick="document.getElementById('f3').click()">Imagen 3<input type="file" id="f3" data-index="2" style="display:none" accept="image/*"></div>
</div>
<div id="prev" class="prev"></div>
<textarea id="comentarios-fotos" rows="3" placeholder="Comentarios sobre fotografías"></textarea>

<h3>Consentimiento</h3>
<textarea id="consentimiento-texto" rows="5" readonly>** Otorgo mi consentimiento libre e informado para la valoración, diagnóstico y tratamiento de fisioterapia.
Entiendo la naturaleza y los posibles riesgos/beneficios de los procedimientos. He recibido explicaciones sobre mi
condición y el plan terapéutico. Acepto la toma de fotografías clínicas para fines de documentación de mi
expediente .**</textarea>
<div class="consentimiento-check">
    <input id="consentimiento-acepto" type="checkbox" required>
    <label for="consentimiento-acepto">Acepto el Consentimiento Informado</label>
</div>

<div class="grid">
    <div>
        <label>Firma Paciente</label>
        <canvas id="sigP"></canvas>
        <button type="button" class="limpiar" onclick="limpiarFirma('sigP')">Borrar Firma</button>
    </div>
    <div>
        <label>Firma Fisio</label>
        <canvas id="sigF"></canvas>
        <button type="button" class="limpiar" onclick="limpiarFirma('sigF')">Borrar Firma</button>
    </div>
</div>
</section>

<button type="button" class="btn" onclick="generarPDF()">GENERAR PDF</button>
</form>
</div>

<script>
// Almacén para las imágenes y sus referencias de entrada
let imagesData = [null, null, null]; // Usamos null para los slots vacíos

document.addEventListener('DOMContentLoaded', () => {
  const sliders = ['eva','fc','fr','temp','spo2','es','di','co','pr','tac','ter','dol','avd','tra','esc','mar','alc','tol'];
  sliders.forEach(id => {
    const s = document.getElementById(id);
    const v = document.getElementById(id+'V');
    if(s && v) {
      v.textContent = s.value;
      s.oninput = () => v.textContent = s.value;
    }
  });

  // Función de carga y reemplazo de imágenes
  ['f1','f2','f3'].forEach((id, index) => {
    const inputElement = document.getElementById(id);
    inputElement.addEventListener('change', e => {
      if(e.target.files[0]) {
        const r = new FileReader();
        r.onload = ev => {
          // Reemplazar la imagen en el slot de datos
          imagesData[index] = { src: ev.target.result, fileInput: inputElement };
          
          // Limpiar el input para que se pueda volver a cargar el mismo archivo (útil para reemplazar)
          e.target.value = '';

          // Redibujar la previsualización
          renderImagePreview();
        };
        r.readAsDataURL(e.target.files[0]);
      }
    });
  });
  
  // Inicialización de Signature Pad
  window.sigP = new SignaturePad(document.getElementById('sigP'));
  window.sigF = new SignaturePad(document.getElementById('sigF'));
});

// Función para renderizar la previsualización de imágenes (maneja el borrado y reemplazo)
function renderImagePreview() {
    const prevContainer = document.getElementById('prev');
    prevContainer.innerHTML = ''; // Limpiar el contenedor actual

    imagesData.forEach((imageData, index) => {
        if (imageData && imageData.src) {
            const container = document.createElement('div');
            container.className = 'image-container';
            container.setAttribute('data-index', index);

            const img = document.createElement('img');
            img.src = imageData.src;
            
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-img-btn';
            deleteBtn.textContent = '×';
            deleteBtn.onclick = () => deleteImage(index);

            container.appendChild(img);
            container.appendChild(deleteBtn);
            prevContainer.appendChild(container);
        }
    });
}

// Función para eliminar una imagen del array de datos
function deleteImage(index) {
    if (imagesData[index]) {
        imagesData[index] = null;
        renderImagePreview();
    }
}

// Función para borrar la firma (Web)
function limpiarFirma(canvasId) {
    if (canvasId === 'sigP' && window.sigP) {
        window.sigP.clear();
    } else if (canvasId === 'sigF' && window.sigF) {
        window.sigF.clear();
    }
}

function get(id) { return document.getElementById(id)?.value.trim() || '-'; }
function checks(id) {
  return Array.from(document.querySelectorAll(`#${id} input:checked`))
         .map(c => c.value).join(', ') || 'Ninguno';
}

// PDF ACTUALIZADO
async function generarPDF() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    const primary = [142, 68, 173];
    const lightGray = [245, 245, 248];
    const darkGray = [90, 90, 90];

    const logoURL = "https://scontent.ftgz1-1.fna.fbcdn.net/v/t39.30808-6/566228684_25020217447666386_1034558766853531360_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=B0GSWpfcMUMQ7kNvwGfHxtF&_nc_oc=Adl0oUrx4ZGWTb3CM9CV-6qITPCP-JxKcN43j_RMBYbHOmlBmShVfA62mszx50faTuE&_nc_zt=23&_nc_ht=scontent.ftgz1-1.fna&_nc_gid=gO3oNE9G78R6UWFn53Ly_A&oh=00_AfmGG1gj061o333dTAL1eoUo8RwdfgaOLICWcYXJiSFhyw&oe=693D630D";

    let y = 35;

    const drawHeader = () => {
      // Barra superior
      doc.setFillColor(...primary);
      doc.rect(0, 0, pageWidth, 20, 'F');

      // Logo ajustado
      try {
        doc.addImage(logoURL, 'PNG', 15, 5, 12, 12);
      } catch (e) { }

      // Nombre de la clínica
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(13);
      doc.setTextColor(255, 255, 255);
      doc.text("FisioHeav", 32, 13);

      // Título PRINCIPAL CENTRADO Y MÁS GRANDE
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text("Reporte Clínico de Fisioterapia", pageWidth / 2, 13, { align: 'center' });
    };

    const drawFooter = (pageNum) => {
      doc.setFontSize(9);
      doc.setTextColor(150, 150, 150);
      doc.text(`Página ${pageNum}`, 20, pageHeight - 10);
      doc.text("Documento clínico profesional", pageWidth - 20, pageHeight - 10, { align: 'right' });
    };

    let pageNum = 1;

    const addNewPage = () => {
      drawFooter(pageNum);
      doc.addPage();
      pageNum++;
      drawHeader();
      y = 30;
    };

    // Primera página
    drawHeader();
    y = 30;

    const fecha = document.getElementById('fecha-reporte').value.split('-').reverse().join('/');
    const folio = "FH-" + Date.now().toString().slice(-6);

    // Helpers
    const block = (title) => {
      if (y > pageHeight - 25) addNewPage();

      doc.setFillColor(...lightGray);
      doc.roundedRect(15, y, pageWidth - 30, 7, 2, 2, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...primary);
      doc.setFontSize(11);
      doc.text(title.toUpperCase(), 20, y + 5);
      y += 10;

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(11);
      doc.setTextColor(0, 0, 0);
    };

    const field = (label, value) => {
      if (y > pageHeight - 15) addNewPage();

      doc.setFont('helvetica', 'bold');
      doc.text(label + ":", 20, y);

      doc.setFont('helvetica', 'normal');
      const txt = (value || '-').trim();
      const lines = doc.splitTextToSize(txt, pageWidth - 65);
      doc.text(lines, 65, y);

      y += (lines.length * 5) + 2;
    };

    // CONTENIDO

    block("Datos Generales");
    field("Profesional", "LFT. Isabel Catalina Herrera Ávila");
    field("Cédula", "15129903");
    field("Clínica", "FisioHeav");
    field("Fecha", fecha);
    field("Folio", folio);

    block("Datos del Paciente");
    field("Nombre", get('nombre-paciente'));
    field("Edad", get('edad-paciente'));
    field("Género", document.getElementById('genero-paciente').value);
    field("Teléfono", get('tel-paciente'));
    field("Ocupación", get('ocupacion-paciente'));
    field("Dominancia", document.getElementById('dominancia-paciente').value);

    block("Anamnesis");
    field("Motivo de consulta", get('mc'));
    field("Padecimiento actual", get('pa'));
    field("Antecedentes", checks('antecedentes'));

    block("Dolor (EVA)");
    field("Dolor actual", document.getElementById('evaV').textContent + "/10");
    field("Localización", get('localizacion-dolor'));
    field("Irradiación", get('patron-irradiacion'));

    block("Exploración Física");
    field("Signos vitales",
      `FC: ${document.getElementById('fcV').textContent} | FR: ${document.getElementById('frV').textContent} | PA: ${get('pa-input')} | Temp: ${document.getElementById('tempV').textContent}°C | SpO2: ${document.getElementById('spo2V').textContent}%`
    );

    field("Balance y coordinación",
      `Estático: ${document.getElementById('esV').textContent}/10, ` +
      `Dinámico: ${document.getElementById('diV').textContent}/10, ` +
      `Coordinación: ${document.getElementById('coV').textContent}/10, ` +
      `Propiocepción: ${document.getElementById('prV').textContent}/10`
    );

    field("ROM activo", get('rom-activo'));
    field("ROM pasivo", get('rom-pasivo'));
    field("Fuerza muscular", get('fuerza-muscular'));
    field("Tono muscular", document.getElementById('tono-muscular').value);

    block("Postura y Marcha");
    field("Tipo de marcha", document.getElementById('marcha-tipo').value);
    field("Asistencia", document.getElementById('asistencia-marcha').value);
    field("Postura", checks('postura'));

    const valoracionFuncionalHeight = 10 + (7 * 7) + 20; 
    if (y + valoracionFuncionalHeight > pageHeight - 25) {
      addNewPage();
    }
    
    block("Valoración Funcional");
    field("AVDs", document.getElementById('avdV').textContent + "/10");
    field("Transferencias", document.getElementById('traV').textContent + "/10");
    field("Escaleras", document.getElementById('escV').textContent + "/10");
    field("Marcha", document.getElementById('marV').textContent + "/10");
    field("Alcance", document.getElementById('alcV').textContent + "/10");
    field("Tolerancia al esfuerzo", document.getElementById('tolV').textContent + "/10");

    block("Diagnóstico y Plan");
    field("Diagnóstico funcional", get('diagnostico-funcional'));
    field("Estado de la lesión", document.getElementById('estado-lesion').value);
    field("Pronóstico corto plazo", document.getElementById('pronostico-corto').value);
    field("Pronóstico largo plazo", document.getElementById('pronostico-largo').value);
    field("Objetivos terapéuticos", get('objetivos-terapeuticos'));
    field("Modalidades", checks('modalidades'));
    field("Indicaciones para casa", get('indicaciones-casa'));
    field("Criterios de alta", get('criterios-alta'));
    field("Seguimiento", get('seguimiento'));

    // ===== PÁGINA FINAL con Documentación y Firmas =====
    addNewPage();

    block("Documentación y Firmas");

    // Impresión del Consentimiento (Texto y Aceptación)
    doc.setFont('helvetica', 'bold');
    doc.text("Consentimiento Informado:", 20, y);
    y += 5;
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    const consentimientoTexto = document.getElementById('consentimiento-texto').value;
    const consentimientoLines = doc.splitTextToSize(consentimientoTexto, pageWidth - 30);
    doc.text(consentimientoLines, 20, y);
    y += (consentimientoLines.length * 4) + 2;

    // Estado de Aceptación
    const acepto = document.getElementById('consentimiento-acepto').checked ? 'SÍ, Aceptado' : 'NO Aceptado';
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(...primary);
    doc.text(`Estado de Aceptación: ${acepto}`, 20, y);
    y += 10;
    doc.setTextColor(0, 0, 0); // Restaurar color
    
    // Comentarios sobre fotografías
    field("Comentarios", get('comentarios-fotos'));
    y += 5;

    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text("Imágenes clínicas:", 20, y);
    y += 5;
    
    // Impresión de las imágenes desde el array imagesData (que contiene solo las subidas)
    const uploadedImages = imagesData.filter(data => data !== null);
    let x = 20;

    uploadedImages.forEach((data, i) => {
      if (i > 0 && i % 3 === 0) { x = 20; y += 50; }
      if (y > pageHeight - 70) addNewPage(); // Chequeo antes de añadir imagen
      
      try { doc.addImage(data.src, 'JPEG', x, y, 45, 45); } catch (e) { console.error("Error al añadir imagen:", e); }
      x += 55; // Ajustar espacio entre imágenes
    });
    
    // Asegurar espacio para las firmas
    y += 60;
    if (y > pageHeight - 50) addNewPage();

    const firma = (label, sig, posX) => {
      if (sig && !sig.isEmpty()) doc.addImage(sig.toDataURL(), 'PNG', posX, y, 60, 25);
      doc.line(posX, y + 30, posX + 60, y + 30);
      doc.setFontSize(10);
      doc.text(label, posX + 30, y + 35, { align: 'center' });
    };

    firma("Firma del Paciente", sigP, 30);
    firma("Firma del Fisioterapeuta", sigF, pageWidth - 90);

    // Pie última página
    drawFooter(pageNum);

    doc.save(`FisioHeav_${get('nombre-paciente').replace(/[^a-zA-Z0-9 ]/g, '_')}_${fecha.replace(/\//g, '-')}.pdf`);

  } catch (e) {
    console.error(e);
    alert("Error: " + e.message);
  }
}

// ✅ PWA: REGISTRO DEL SERVICE WORKER (Añadido aquí)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // Asegúrate de que la ruta a sw.js sea correcta. Usamos el raíz (/)
        navigator.serviceWorker.register('sw.js')
            .then(registration => {
                console.log('ServiceWorker registrado con éxito:', registration.scope);
            })
            .catch(error => {
                console.log('Fallo el registro de ServiceWorker:', error);
            });
    });
}
</script>
</body>
</html>